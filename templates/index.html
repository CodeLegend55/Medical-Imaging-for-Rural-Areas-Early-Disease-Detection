<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Imaging Analysis System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 50px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background-color: #ecf0f1;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background-color: #d5f4e6;
        }

        .upload-icon {
            font-size: 4em;
            color: #3498db;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .upload-subtext {
            color: #7f8c8d;
            font-size: 1em;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .result-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 10px 10px 0 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .prediction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .prediction-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #3498db;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .prediction-card.fracture-model {
            border-left-color: #e67e22;
        }

        .prediction-card.osteoporosis-model {
            border-left-color: #9b59b6;
        }

        .prediction-card.best-model {
            border: 2px solid #f39c12;
            box-shadow: 0 5px 20px rgba(243, 156, 18, 0.3);
        }

        .xray-type-indicator {
            background: rgba(52, 152, 219, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1em;
            text-align: center;
        }

        .xray-type-selection {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .xray-type-selection h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .radio-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .radio-option:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            margin-top: 5px;
            transform: scale(1.2);
        }

        .radio-option input[type="radio"]:checked + .radio-label {
            color: #3498db;
            font-weight: bold;
        }

        .radio-option:has(input[type="radio"]:checked) {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .radio-label {
            flex: 1;
            font-size: 1.1em;
            line-height: 1.4;
        }

        .radio-label small {
            color: #666;
            font-weight: normal;
        }

        @media (max-width: 768px) {
            .radio-group {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .radio-group {
                grid-template-columns: 1fr 1fr;
            }
        }

        .prediction-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .prediction-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .diagnosis {
            font-weight: bold;
            font-size: 1.1em;
        }

        .confidence {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .confidence.covid { background: #e74c3c; }
        .confidence.pneumonia { background: #f39c12; }
        .confidence.tuberculosis { background: #9b59b6; }
        .confidence.normal { background: #27ae60; }
        .confidence.fracture { background: #e67e22; }
        .confidence.nofracture { background: #27ae60; }
        .confidence.osteoporosis { background: #9b59b6; }

        .probabilities {
            margin-top: 15px;
        }

        .probability-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px 12px;
            background: #ecf0f1;
            border-radius: 5px;
        }

        .probability-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .ensemble-result {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .ensemble-result h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .ensemble-diagnosis {
            font-size: 2em;
            font-weight: bold;
            margin: 15px 0;
        }

        .secondary-findings {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .finding-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .finding-card.fracture {
            border-color: #e67e22;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
        }

        .finding-card.osteoporosis {
            border-color: #9b59b6;
            background: linear-gradient(135deg, #fd79a8, #fdcb6e);
        }

        .finding-type {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .finding-result {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .finding-confidence {
            background: rgba(255, 255, 255, 0.8);
            color: #2c3e50;
            padding: 8px 15px;
            border-radius: 15px;
            font-weight: bold;
        }

        .medical-report {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 0.95em;
            color: #2c3e50;
            max-height: 600px;
            overflow-y: auto;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .warning {
            background: #f39c12;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .image-preview {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            margin: 20px auto;
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .prediction-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 Medical Imaging AI System</h1>
            <p>Advanced X-ray analysis with ensemble AI models for chest conditions, fracture detection, and osteoporosis screening</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📱</div>
                    <div class="upload-text">Drop your X-ray image here</div>
                    <div class="upload-subtext">Select problem type and upload your image<br>(PNG, JPG, JPEG - Max 16MB)</div>
                    <input type="file" id="fileInput" accept=".png,.jpg,.jpeg" />
                </div>
                
                <!-- Problem type selection -->
                <div class="xray-type-selection" id="problemTypeSelection" style="display: none;">
                    <h3>Select Problem Type to Detect:</h3>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="problemType" value="chest" checked>
                            <span class="radio-label">
                                🫁 <strong>Chest Conditions</strong>
                                <br><small>COVID-19, Pneumonia, TB detection using chest X-rays</small>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="problemType" value="fracture">
                            <span class="radio-label">
                                🦴 <strong>Fracture Detection</strong>
                                <br><small>Bone fracture identification using specialized models</small>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="problemType" value="osteoporosis">
                            <span class="radio-label">
                                🦴 <strong>Osteoporosis Detection</strong>
                                <br><small>Bone density analysis for osteoporosis screening</small>
                            </span>
                        </label>
                    </div>
                </div>
                
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Select Image
                </button>
                <button class="btn" id="analyzeBtn" onclick="analyzeImage()" disabled>
                    🔍 Analyze Image
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>Analyzing image with ensemble AI models...</p>
                <p><small>Processing with 3 specialized models for accurate diagnosis</small></p>
            </div>

            <div class="results" id="results">
                <div class="ensemble-result" id="ensembleResult">
                    <h2>🎯 Primary Diagnosis</h2>
                    <div class="ensemble-diagnosis" id="ensembleDiagnosis"></div>
                    <div id="ensembleConfidence"></div>
                </div>

                <div class="result-section" id="secondaryFindingsSection" style="display: none;">
                    <div class="result-header">� Additional Findings</div>
                    <div class="secondary-findings" id="secondaryFindings"></div>
                </div>

                <div class="result-section">
                    <div class="result-header">�📊 All Model Predictions</div>
                    <div class="prediction-grid" id="predictionGrid"></div>
                </div>

                <div class="result-section">
                    <div class="result-header">📋 Medical Report</div>
                    <div class="medical-report" id="medicalReport"></div>
                </div>

                <button class="btn" onclick="resetForm()">🔄 Analyze Another Image</button>
            </div>

            <div class="warning">
                ⚠️ <strong>Medical Disclaimer:</strong> This AI system uses user-selected problem detection for specialized analysis. Results are for screening purposes only and should not replace professional medical diagnosis. Always consult with qualified healthcare professionals for final diagnosis and treatment decisions.
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;

        // File input handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFileSelect(e.target.files[0]);
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            uploadArea.classList.add('dragover');
        }

        function unhighlight() {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
            if (!allowedTypes.includes(file.type)) {
                showError('Please select a valid image file (PNG, JPG, JPEG)');
                return;
            }

            // Validate file size (16MB)
            if (file.size > 16 * 1024 * 1024) {
                showError('File size must be less than 16MB');
                return;
            }

            selectedFile = file;
            
            // Update UI
            const uploadText = document.querySelector('.upload-text');
            uploadText.textContent = `Selected: ${file.name}`;
            
            // Show image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const existingPreview = document.getElementById('imagePreview');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                const img = document.createElement('img');
                img.id = 'imagePreview';
                img.src = e.target.result;
                img.className = 'image-preview';
                uploadArea.appendChild(img);
            };
            reader.readAsDataURL(file);
            
            // Show problem type selection
            document.getElementById('problemTypeSelection').style.display = 'block';
            
            // Enable analyze button
            document.getElementById('analyzeBtn').disabled = false;
            
            // Hide previous results
            document.getElementById('results').style.display = 'none';
        }

        function analyzeImage() {
            if (!selectedFile) {
                showError('Please select an image first');
                return;
            }

            // Get selected problem type
            const selectedProblemType = document.querySelector('input[name="problemType"]:checked')?.value;
            if (!selectedProblemType) {
                showError('Please select problem type');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;

            // Create form data
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('problem_type', selectedProblemType);

            // Send request
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    document.getElementById('analyzeBtn').disabled = false;
                    return;
                }

                // Display results
                displayResults(data);
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                showError('Network error: ' + error.message);
                document.getElementById('analyzeBtn').disabled = false;
            });
        }

        function displayResults(data) {
            // Show problem type selection result
            const problemType = data.routing_info?.problem_type || 'unknown';
            const modelsUsed = data.routing_info?.models_used || [];
            
            // Add problem type indicator
            const ensembleResult = document.getElementById('ensembleResult');
            const problemTypeIndicator = document.createElement('div');
            problemTypeIndicator.style.marginBottom = '15px';
            problemTypeIndicator.style.fontSize = '1.1em';
            problemTypeIndicator.style.opacity = '0.9';
            
            if (problemType === 'chest') {
                problemTypeIndicator.innerHTML = `🫁 <strong>Chest Condition Detection</strong> - Using 3 PyTorch ensemble models`;
                problemTypeIndicator.style.background = 'rgba(52, 152, 219, 0.2)';
            } else if (problemType === 'fracture') {
                problemTypeIndicator.innerHTML = `🦴 <strong>Fracture Detection</strong> - Using 3 PyTorch ensemble models`;
                problemTypeIndicator.style.background = 'rgba(230, 126, 34, 0.2)';
            } else if (problemType === 'osteoporosis') {
                problemTypeIndicator.innerHTML = `🦴 <strong>Osteoporosis Detection</strong> - Using 3 PyTorch ensemble models`;
                problemTypeIndicator.style.background = 'rgba(155, 89, 182, 0.2)';
            }
            
            problemTypeIndicator.style.padding = '10px 15px';
            problemTypeIndicator.style.borderRadius = '8px';
            problemTypeIndicator.style.marginBottom = '20px';
            
            // Show ensemble result
            const ensembleDiagnosis = document.getElementById('ensembleDiagnosis');
            const ensembleConfidence = document.getElementById('ensembleConfidence');
            
            ensembleDiagnosis.textContent = data.ensemble.diagnosis;
            
            // Show best model information if available
            let confidenceText = `Confidence: <strong>${data.ensemble.confidence.toFixed(1)}%</strong>`;
            if (data.routing_info?.best_model) {
                const bestModel = data.routing_info.best_model;
                confidenceText += `<br><small>Best model: ${bestModel.name}</small>`;
            }
            ensembleConfidence.innerHTML = confidenceText;
            
            // Insert problem type indicator at the top of ensemble result
            const existingIndicator = ensembleResult.querySelector('.problem-type-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            problemTypeIndicator.className = 'problem-type-indicator';
            ensembleResult.insertBefore(problemTypeIndicator, ensembleResult.firstChild.nextSibling);
            
            // Color code based on diagnosis and problem type
            const diagnosisColors = {
                'COVID19': '#e74c3c',
                'PNEUMONIA': '#f39c12',
                'TURBERCULOSIS': '#9b59b6',
                'NORMAL': '#27ae60',
                'FRACTURED': '#e67e22',
                'NON_FRACTURED': '#27ae60',
                'OSTEOPOROSIS': '#9b59b6'
            };
            
            const primaryColor = diagnosisColors[data.ensemble.diagnosis] || '#8e44ad';
            ensembleResult.style.background = `linear-gradient(135deg, ${primaryColor}, #9b59b6)`;

            // Show secondary findings if available
            const secondaryFindingsSection = document.getElementById('secondaryFindingsSection');
            const secondaryFindings = document.getElementById('secondaryFindings');
            
            if (data.ensemble.secondary_findings && data.ensemble.secondary_findings.length > 0) {
                secondaryFindings.innerHTML = '';
                
                data.ensemble.secondary_findings.forEach(finding => {
                    const findingCard = document.createElement('div');
                    findingCard.className = `finding-card ${finding.type.toLowerCase()}`;
                    
                    findingCard.innerHTML = `
                        <div class="finding-type">${finding.type} Detection</div>
                        <div class="finding-result">${finding.finding}</div>
                        <div class="finding-confidence">Confidence: ${finding.confidence.toFixed(1)}%</div>
                    `;
                    
                    secondaryFindings.appendChild(findingCard);
                });
                
                secondaryFindingsSection.style.display = 'block';
            } else {
                secondaryFindingsSection.style.display = 'none';
            }

            // Show individual model predictions
            const predictionGrid = document.getElementById('predictionGrid');
            predictionGrid.innerHTML = '';

            Object.entries(data.predictions).forEach(([modelName, prediction]) => {
                const card = document.createElement('div');
                card.className = 'prediction-card';
                
                const confidenceClass = prediction.class.toLowerCase().replace('19', '').replace('_', '');
                
                // Handle different model types with appropriate styling
                let modelDisplayName = modelName;
                let cardClass = 'prediction-card';
                
                if (modelName.includes('Fracture_')) {
                    cardClass += ' fracture-model';
                    const modelType = modelName.split('_')[1]; // Extract ResNet50, DenseNet121, etc.
                    modelDisplayName = `🦴 ${modelType} (Fracture)`;
                } else if (modelName.includes('Osteoporosis_')) {
                    cardClass += ' osteoporosis-model';
                    const modelType = modelName.split('_')[1]; // Extract ResNet50, DenseNet121, etc.
                    modelDisplayName = `🦴 ${modelType} (Osteoporosis)`;
                } else if (modelName.includes('Legacy_Fracture')) {
                    cardClass += ' fracture-model';
                    modelDisplayName = '🦴 Legacy Fracture Model';
                } else {
                    modelDisplayName = `🫁 ${modelName}`;
                }
                
                // Highlight the best performing model
                if (data.routing_info?.best_model?.name === modelName) {
                    cardClass += ' best-model';
                }
                
                card.className = cardClass;
                
                let cardHTML = `
                    <h3>${modelDisplayName}`;
                
                if (data.routing_info?.best_model?.name === modelName) {
                    cardHTML += ` <span style="color: #f39c12; font-size: 0.8em;">⭐ BEST</span>`;
                }
                
                cardHTML += `</h3>
                    <div class="prediction-result">
                        <span class="diagnosis">${prediction.class}</span>
                        <span class="confidence ${confidenceClass}">${prediction.confidence}%</span>
                    </div>
                    <div class="probabilities">
                        <strong>All Probabilities:</strong>
                        ${Object.entries(prediction.probabilities).map(([cls, prob]) => 
                            `<div class="probability-bar">
                                <span>${cls}</span>
                                <span class="probability-value">${prob}%</span>
                            </div>`
                        ).join('')}
                    </div>
                `;
                
                card.innerHTML = cardHTML;
                predictionGrid.appendChild(card);
            });

            // Show medical report
            document.getElementById('medicalReport').textContent = data.report;

            // Show results section
            document.getElementById('results').style.display = 'block';
        }

        function resetForm() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('results').style.display = 'none';
            document.getElementById('problemTypeSelection').style.display = 'none';
            
            // Reset problem type selection to chest (default)
            document.querySelector('input[name="problemType"][value="chest"]').checked = true;
            
            // Reset upload area
            const uploadText = document.querySelector('.upload-text');
            uploadText.textContent = 'Drop your X-ray image here';
            
            // Remove image preview
            const existingPreview = document.getElementById('imagePreview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Remove any error messages
            const existingErrors = document.querySelectorAll('.error');
            existingErrors.forEach(error => error.remove());
        }

        function showError(message) {
            // Remove existing error messages
            const existingErrors = document.querySelectorAll('.error');
            existingErrors.forEach(error => error.remove());
            
            // Create new error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // Insert after upload section
            const uploadSection = document.querySelector('.upload-section');
            uploadSection.parentNode.insertBefore(errorDiv, uploadSection.nextSibling);
        }

        // Check server health on page load
        fetch('/health')
            .then(response => response.json())
            .then(data => {
                console.log('Server status:', data);
                if (data.models_loaded === 0) {
                    showError('Warning: No AI models are currently loaded. Please check the server configuration.');
                }
            })
            .catch(error => {
                console.error('Could not check server health:', error);
            });
    </script>
</body>
</html>